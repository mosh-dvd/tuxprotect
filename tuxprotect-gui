#!/bin/bash
# Tux Protect GUI Indicator
# This script runs as the logged-in user and displays the status icon.

STATUS_FILE="/run/tuxprotect/status"
SHIELD_OPEN="/usr/share/tuxprotect/res/icons/shield.png"
SHIELD_BLOCKED="/usr/share/tuxprotect/res/icons/shieldb.png"
SHIELD_NO_NET="/usr/share/tuxprotect/res/icons/shieldc.png"

# Ensure the indicator isn't already running
killall tuxprotectgui 2>/dev/null

# Wait for the status file to be created by the daemon
while [ ! -f "$STATUS_FILE" ]; do
    sleep 1
done

current_icon=""
while true; do
    # Check if status file exists, exit if daemon stopped
    if [ ! -f "$STATUS_FILE" ]; then
        killall tuxprotectgui 2>/dev/null
        exit 0
    fi

    status=$(cat "$STATUS_FILE")
    icon_to_show=""

    case "$status" in
        open)
            icon_to_show=$SHIELD_OPEN
            ;;
        blocked)
            icon_to_show=$SHIELD_BLOCKED
            ;;
        no-internet)
            icon_to_show=$SHIELD_NO_NET
            ;;
    esac

    # Only restart the GUI if the icon needs to change
    if [[ "$icon_to_show" != "$current_icon" && -n "$icon_to_show" ]]; then
        current_icon="$icon_to_show"
        killall tuxprotectgui 2>/dev/null
        # הוספת תפריט קליק-ימני בסיסי
        /usr/bin/tuxprotectgui --image="$current_icon" --menu="Restart Services!/usr/share/tuxprotect/restartservices" --listen &
    fi
    
    sleep 5
done